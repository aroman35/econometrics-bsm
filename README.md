# Анализ факторов отклонения цен опционов от модели Блэка–Шоулза

## 1. Цель и постановка задачи

Цель проекта — **эмпирически исследовать факторы, влияющие на отклонения рыночных цен опционов от теоретических значений, рассчитанных по модели Блэка–Шоулза–Мертона (Black–Scholes–Merton, BSM)**.

Задачи исследования:
- сформировать кросс-секцию цен опционов на фиксированный момент времени;
- вычислить теоретические цены опционов по модели BSM;
- сконструировать экономически осмысленный набор факторов (регрессоров), не содержащий линейно-зависимых координат;
- оценить регрессионную модель логарифмической ошибки ценообразования;
- интерпретировать вклад каждого фактора с точки зрения финансовой теории и рыночных фрикций.

---

## 2. Данные и источники

- **Источник котировок и сделок:** агрегатор **Tardis.dev** (исторические нормализованные данные).
- **Площадки:**
  - OKX (options, spot, perpetual swaps),
  - Binance (spot, USDT-margined futures).
- **Базовый актив:** Bitcoin, пары BTC-USDT / BTCUSDT.
- **Дата и время snapshot:** **2024-10-01 12:00:00 UTC**.
- **Тип данных:**
  - опционы OKX через `okex-options / options_chain`;
  - spot-транзакции OKX и Binance;
  - perpetual swaps OKX и Binance;
  - данные используются только в виде кросс-секционного среза (без временных рядов и панелей в итоговой регрессии).

Фактическое построение кросс-секции реализовано в скрипте:

- `scripts/tardis_okx_binance_cross_section.py`

Результирующий файл:

- `data/okx_binance_options_cross_section_YYYYMMDD_HHMMSS+0000.csv`

(конкретное имя зависит от параметров snapshot).

---

## 3. Теоретическая основа

### 3.1. Модель Блэка–Шоулза–Мертона

Цена европейского call-опциона в модели BSM:

$$
C = S_0 N(d_1) - K e^{-rT} N(d_2),
$$

где

$$
d_1 = \frac{\ln(S_0/K) + (r + \sigma^2/2)T}{\sigma\sqrt{T}}, \qquad
d_2 = d_1 - \sigma\sqrt{T},
$$

а \( S_0 \) — цена базового актива, \( K \) — страйк, \( T \) — время до экспирации, \( r \) — безрисковая ставка, \( \sigma \) — волатильность, \( N(\cdot) \) — стандартная нормальная CDF.

Для put-опциона:

$$
P = K e^{-rT} N(-d_2) - S_0 N(-d_1).
$$

### 3.2. Мера отклонения (mispricing)

В качестве зависимой переменной используем **логарифмическую ошибку** между рыночной ценой и модельной ценой:

$$
bsm\_error\_log = \ln \frac{P_{\text{mkt}}}{P_{\text{BSM}}},
$$

где \( P_{\text{mkt}} \) — наблюдаемая рыночная цена опциона, \( P_{\text{BSM}} \) — теоретическая цена по BSM.

Интерпретация:
- \( bsm\_error\_log > 0 \): опцион переоценён относительно модели BSM;
- \( bsm\_error\_log < 0 \): опцион недооценён.

Также рассчитываются вспомогательные меры:
- \( bsm\_error\_rel = (P_{\text{mkt}} - P_{\text{BSM}}) / P_{\text{BSM}} \),
- \( bsm\_error\_raw = P_{\text{mkt}} - P_{\text{BSM}} \),
но основной объект анализа — именно лог-ошибка.

---

## 4. Формирование факторов

Кросс-секция строится на один фиксированный snapshot. Для каждого опциона рассчитываются:

1. **Опорная цена базового актива**

$$
S_{\text{ref}} = \frac{S_{\text{OKX}}^{\text{spot}} + S_{\text{Binance}}^{\text{spot}}}{2}.
$$

2. **Log-moneyness**

$$
log\_moneyness = \ln\left(\frac{S_{\text{ref}}}{K}\right).
$$

3. **Срок до экспирации**

$$
time\_to\_maturity\_years = T = \frac{\text{expiry} - \text{snapshot}}{365}.
$$

4. **Разрыв IV–RV**

$$
iv\_rv\_gap = IV_{\text{mark}} - RV_{\text{14d}},
$$

где \( RV_{\text{14d}} \) — реализованная годовая волатильность BTCUSDT за 14 дней до snapshot, рассчитанная по данным Binance spot.

5. **Относительный bid-ask спред**

$$
rel\_bid\_ask\_spread = \frac{ask - bid}{mid},
$$

где mid — mid-quote или mark price.

6. **Нормированный open interest**

$$
oi\_rel = \frac{OI_i}{\max_j OI_j}.
$$

7. **Нелинейное взаимодействие глубины и срока**

$$
ttm\_x\_abs\_log\_moneyness = T \cdot \left| \ln \left( \frac{S_{\text{ref}}}{K} \right) \right|.
$$
8. **Dummy-переменная типа опциона**

- `is_call = 1` для call-опционов,
- `is_call = 0` для put-опционов.

### Итоговый набор факторов в регрессионном датасете

Файл `data/bsm_regression_dataset_*.csv` содержит:

- зависимую переменную: `bsm_error_log`;
- факторы в исходном виде;
- стандартизированные версии (z-score): `*_z`;
- служебные идентификаторы контрактов.

Лишние и линейно-зависимые признаки (например, квадраты, дублирующие dummy, константные по срезу величины) намеренно не включены.

---

## 5. Разведочный анализ данных (EDA)

Код: `scripts/analyze_factors.py`  
Отчёты: `reports/eda/`

### 5.1. Корреляционная структура

![Correlation Heatmap](reports/eda/corr_heatmap.png)

Наблюдения:
- сильная положительная связь `log_moneyness` и `iv_rv_gap` (отражает улыбку/смёрк волатильности);
- остальные факторы не демонстрируют критической мультиколлинеарности.

### 5.2. Дисперсии факторов

![Factor Variances](reports/eda/factor_variances.png)

Все факторы обладают ненулевой дисперсией; наиболее вариативны `log_moneyness` и взаимодействие с TTM.

### 5.3. Распределения факторов

![Boxplot of Factors](reports/eda/factor_boxplot.png)

Замечания:
- выбросы по спредам и open interest соответствуют неликвидным страйкам;
- структура данных соответствует ожиданиям для кросс-секции крипто-опционов.

---

## 6. Регрессионная модель

### 6.1. Спецификация

Основная модель:

$$
bsm\_error\_log_{i} = \beta_{0} +
\beta_{1} \cdot log\_moneyness\_{z,i} +
\beta_{2} \cdot time\_to\_maturity\_years\_{z,i} +
\beta_{3} \cdot iv\_rv\_gap\_{z,i} +
\beta_{4} \cdot log\_rel\_bid\_ask\_spread\_{z,i} +
\beta_{5} \cdot oi\_rel\_{z,i} +
\beta_{6} \cdot ttm\_x\_abs\_log\_moneyness\_{z,i} +
\beta_{7} \cdot is\_call_{i} + \varepsilon_{i}.
$$

Где:
- непрерывные факторы взяты в стандартизированном виде (z-score),
- `is_call` — бинарная переменная,
- оценивание: **OLS + робастные стандартные ошибки HC3**,
- целевая переменная: `bsm_error_log`.

Реализация: `scripts/run_regression.py`  
Подготовка датасета: `scripts/build_regression_dataset.py`  
Проверка мультиколлинеарности (VIF): `reports/regression/vif_table.csv`.

---

## 7. Результаты оценки

Численные результаты регрессии сохраняются в:

- `reports/regression/ols_results_bsm_error_log.csv`

Формат вывода (пример структуры таблицы):

| Переменная | Коэффициент | Ст. ошибка | t-статистика | p-value | Значимость |
|-----------|-------------|-----------|-------------|--------|-----------|
| const | ... | ... | ... | ... |   |
| log_moneyness_z | ... | ... | ... | ... | * |
| time_to_maturity_years_z | ... | ... | ... | ... |   |
| iv_rv_gap_z | ... | ... | ... | ... | ** |
| log_rel_bid_ask_spread_z | ... | ... | ... | ... | * |
| oi_rel_z | ... | ... | ... | ... |   |
| ttm_x_abs_log_moneyness_z | ... | ... | ... | ... | ** |
| is_call | ... | ... | ... | ... | * |

(см. актуальные значения в CSV-файле репозитория).

---

## 8. Интерпретация ключевых коэффициентов

Интерпретация дана для z-скорированных факторов:

- **log_moneyness_z**  
  Положительный и значимый коэффициент (при наличии) указывает на то, что глубокие OTM/ITM опционы демонстрируют систематическое отклонение от BSM, что согласуется с эффектом улыбки волатильности.

- **iv_rv_gap_z**  
  Положительный значимый эффект интерпретируется как премия за риск волатильности: чем сильнее implied volatility превышает реализованную, тем выше переоценка опционов относительно BSM.

- **log_rel_bid_ask_spread_z**  
  Положительный знак свидетельствует о том, что менее ликвидные опционы (широкие спреды) систематически сильнее отклоняются от теоретических цен из-за торговых издержек и ограничений арбитража.

- **oi_rel_z**  
  Отрицательный коэффициент (при значимости) говорит о том, что по наиболее ликвидным страйкам mispricing меньше — рынок эффективнее.

- **ttm_x_abs_log_moneyness_z**  
  Значимый коэффициент указывает на важность нелинейного взаимодействия срока и глубины опциона при объяснении отклонений от BSM.

- **is_call**  
  Значимость dummy отражает асимметрию между ценами call и put, не учитываемую классической моделью BSM.

---

## 9. Основные выводы

1. **Модель Блэка–Шоулза в чистом виде недостаточна** для описания цен опционов на криптовалютном рынке.
2. **Существенную роль играют:**
   - структура moneyness (улыбка/смёрк волатильности),
   - разрыв между implied и реализованной волатильностью,
   - ликвидность (bid-ask spread),
   - концентрация открытого интереса,
   - тип опциона (CALL vs PUT).
3. Результаты согласуются с современной литературой по mispricing деривативов и подтверждают влияние рыночных фрикций и волатильностных премий.
4. Построенная инфраструктура (Tardis + OKX/Binance + автоматический пайплайн) позволяет масштабировать анализ:
   - на несколько дат snapshot,
   - на панельные модели,
   - на альтернативные спецификации факторов.

---

## 10. Структура репозитория

Ключевые элементы проекта:

- `scripts/tardis_okx_binance_cross_section.py` — загрузка данных Tardis, построение кросс-секции опционов и факторов.
- `scripts/analyze_factors.py` — EDA, корреляции, дисперсии, сохранение графиков.
- `scripts/build_regression_dataset.py` — расчёт BSM-цен, ошибок и стандартизированных факторов.
- `scripts/run_regression.py` — оценка OLS-модели с робастными ошибками, вывод коэффициентов.
- `data/` — кросс-секционные и регрессионные датасеты.
- `reports/eda/` — графики EDA (heatmap, variances, boxplot).
- `reports/regression/` — результаты регрессии (`ols_results_bsm_error_log.csv`, `vif_table.csv`).
- `Regression_Results_Report_GitHub.md` — детализированное текстовое описание результатов регрессии.
- `README_CROSS_SECTION_FACTORS_LATEX.md` — документация по формированию кросс-секции и факторов.

---

**Итог:**  
Проект реализует полный воспроизводимый пайплайн от получения высокочастотных данных по опционам до эконометрического анализа факторов mispricing относительно модели Блэка–Шоулза. README отражает логику исследования и может использоваться как основа для итогового академического отчёта.
