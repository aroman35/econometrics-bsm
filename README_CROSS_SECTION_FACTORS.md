# Документация к скрипту формирования cross-section (OKX + Binance + Tardis)

Этот README описывает итоговый скрипт формирования кросс-секционных данных по опционам OKX с использованием исторических данных Tardis.dev и набор факторов, включённых в результирующий CSV-файл.

## 1. Назначение скрипта

Скрипт `tardis_okx_binance_cross_section.py` строит **одну кросс-секцию** опционов на фиксированный момент времени (snapshot):

- Источник данных: **Tardis.dev** (нормализованные CSV).
- Опционы: **OKX** через `okex-options / options_chain`.
- Базовый актив и дополнительные котировки: **OKX spot**, **Binance spot**, **OKX perp**, **Binance perp` trades`**.
- Результат: CSV-файл, где **каждая строка — один опцион** (тип–страйк–срок) на момент snapshot с готовыми факторами под последующий регрессионный анализ отклонений от BSM.

Скрипт использует только исторические данные Tardis и не ходит напрямую на биржи.

## 2. Логика работы

1. Читает настройки snapshot (дата и время в UTC).
2. Скачивает через Tardis:
   - `okex-options / options_chain` для указанного дня;
   - `okex / trades` для спота BTC-USDT;
   - `binance / trades` для спота BTCUSDT;
   - `okex-swap / trades` для BTC-USDT-SWAP (perp);
   - `binance-futures / trades` для btcusdt (perp).
3. Определяет:
   - последнюю цену спота на OKX и Binance до snapshot;
   - последнюю цену perp на OKX и Binance до snapshot;
   - **реализованную волатильность** (annualized) за 14 дней по Binance spot.
4. По `options_chain`:
   - для каждой комбинации (тип опциона, страйк, экспирация) выбирает **последнюю запись до snapshot**;
   - фильтрует только опционы с валидными ценами и параметрами.
5. Для каждого опциона считает набор факторов (см. ниже).
6. Сохраняет результирующий файл `okx_binance_options_cross_section_*.csv` c только нужными колонками.
7. Дополнительно печатает корреляционную матрицу факторов для проверки мультиколлинеарности.

## 3. Формат выходного CSV

Каждая строка соответствует одному опциону OKX на момент snapshot.

### 3.1. Базовые поля

- `snapshot_time_utc`  
  Время snapshot в UTC (ISO 8601). Одинаково для всех строк.

- `underlying_price_ref`  
  Опорная цена базового актива:
  \[ S_{ref} = (S_{OKX}^{spot} + S_{Binance}^{spot}) / 2. \]

- `realized_vol_14d_ann`  
  Реализованная годовая волатильность BTCUSDT за 14 дней до snapshot. Общая для всех опционов данного среза.

- `option_type`  
  Тип опциона: `"CALL"` или `"PUT"` (строка).

- `is_call`  
  Фиктивная переменная:
  - `1` — CALL,
  - `0` — PUT.

- `strike`  
  Страйк опциона \(K\).

- `expiry_utc`  
  Дата и время экспирации опциона в UTC.

- `time_to_maturity_years`  
  Срок до экспирации в годах:
  \[ T = (expiry - snapshot) / 365. \]

- `option_price`  
  Выбранная рыночная цена опциона на момент snapshot:
  - приоритет: `mark_price`,
  - затем mid `(bid+ask)/2`,
  - затем `bid` или `ask`, если других нет.

### 3.2. Факторы для регрессии

Ниже — **итоговый, очищенный набор факторов**, который формируется в CSV и может использоваться для модели ошибок BSM в одном cross-section с константой.

1. `log_moneyness`  
   \[ \ln(S_{ref} / K) \]  
   Базовый фактор: положение страйка относительно цены. Описывает улыбку/смёрк волатильности.

2. `time_to_maturity_years`  
   (см. выше)  
   Фактор сроковой структуры: как отклонения зависят от горизонта.

3. `ttm_x_abs_log_moneyness`  
   \[ T \times |\ln(S_{ref}/K)| \]  
   Взаимодействие глубины и срока. Позволяет гибко моделировать разную чувствительность для глубоких OTM/ITM и разных сроков. Не является линейной комбинацией других факторов.

4. `iv_rv_gap`  
   \[ \text{IV}_{mark} - \text{RV}_{14d} \]  
   Разница между рыночной implied volatility (из `mark_iv`, если доступна) и реализованной волатильностью. Интерпретация:
   - премия за риск волатильности,
   - возможное систематическое отклонение от BSM-допущений.

5. `rel_bid_ask_spread`  
   Относительный спред ликвидности:
   \[ (ask - bid) / mid \]
   где mid — mid-quote или `mark_price`. Характеризует торговые издержки, ширину рынка и ограничения арбитража; логично связан с величиной mispricing.

6. `oi_rel`  
   Относительный open interest для контракта:
   \[ oi\_rel = \frac{OI_i}{\max_j OI_j} \]
   (если OI в данных есть; иначе поле пустое).  
   Отражает концентрацию интереса/ликвидности вокруг данного страйка/срока.

7. `is_call`  
   (см. выше)  
   Dummy-переменная для асимметрии между CALL и PUT в отклонениях от BSM.

Все перечисленные факторы:
- имеют экономически интерпретируемый смысл;
- не находятся в точной линейной зависимости друг с другом или с константой в рамках одного snapshot;
- подходят под требования курса по эконометрике и стандартам QF/CFA-подхода.

### 3.3. Что намеренно **не включено**

Для избежания путаницы и мультиколлинеарности в итоговый CSV **не добавляются**:

- `log_moneyness_sq`, `ttm_sq` — дают почти линейную зависимость с базовыми переменными;
- `is_put` — линейно зависит от `is_call`;
- `abs_log_moneyness` — используется только внутри `ttm_x_abs_log_moneyness`;
- глобальные для snapshot величины (`spot_venue_diff`, `okx_basis`, `binance_basis`) — константны по срезу, дублируют константу в регрессии;
- технические поля (`bid_price`, `ask_price`, `mark_price`, `bid_iv`, `ask_iv`) — используются при расчётах, но не сохраняются в финальный файл, чтобы не перегружать датасет.

При необходимости эти величины можно восстановить, модифицировав скрипт, но для учебного проекта и чистоты регрессии итоговый CSV содержит только необходимые и согласованные столбцы.

## 4. Как использовать

1. Установить зависимости:
   - `tardis-dev`
   - `pandas`
2. Задать переменную окружения:
   - `TARDIS_API_KEY="ваш_ключ"`
3. Настроить в скрипте дату snapshot и (опционально) фильтр по базовому активу.
4. Запустить:
   ```bash
   python tardis_okx_binance_cross_section.py
   ```
5. В каталоге `data/` появится файл вида:
   ```
   okx_binance_options_cross_section_YYYYMMDD_HHMMSS+0000.csv
   ```
   готовый к расчёту BSM-цен и построению регрессионной модели ошибок.
